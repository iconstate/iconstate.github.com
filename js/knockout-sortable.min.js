//knockout-sortable | (c) 2012 Ryan Niemeyer | http://www.opensource.org/licenses/mit-license
(function(a,b,c){var d="ko_sortItem",e="ko_sortList",f="ko_parentList",g=function(b,c){a.utils.arrayForEach(b,function(b){b.nodeType===1&&(a.utils.domData.set(b,d,c),a.utils.domData.set(b,f,a.utils.domData.get(b.parentNode,e)))})},h=function(b){var c={},d=a.utils.unwrapObservable(b()),e;return d.data?(c.foreach=d.data,c.name=d.template):c.foreach=b(),a.utils.arrayForEach(["afterAdd","afterRender","beforeRemove","includeDestroyed","templateEngine","templateOptions"],function(b){c[b]=d[b]||a.bindingHandlers.sortable[b]}),c.afterRender?(e=c.afterRender,c.afterRender=function(a,b){g.call(b,a,b),e.call(b,a,b)}):c.afterRender=g,c};a.bindingHandlers.sortable={init:function(g,i,j,k,l){var m=b(g),n=a.utils.unwrapObservable(i())||{},o=h(i),p={},q,r;return a.utils.arrayForEach(g.childNodes,function(a){a&&a.nodeType===3&&a.parentNode.removeChild(a)}),b.extend(!0,p,a.bindingHandlers.sortable),n.options&&p.options&&(a.utils.extend(p.options,n.options),delete n.options),a.utils.extend(p,n),p.connectClass&&(a.isObservable(p.allowDrop)||typeof p.allowDrop=="function")?a.computed({read:function(){var b=a.utils.unwrapObservable(p.allowDrop),c=typeof b=="function"?b.call(this,o.foreach):b;a.utils.toggleDomNodeCssClass(g,p.connectClass,c)},disposeWhenNodeIsRemoved:g},this):a.utils.toggleDomNodeCssClass(g,p.connectClass,p.allowDrop),a.bindingHandlers.template.init(g,function(){return o},j,k,l),q=p.options.start,r=p.options.update,setTimeout(function(){m.sortable(a.utils.extend(p.options,{start:function(a,b){b.item.find("input:focus").change(),q&&q.apply(this,arguments)},update:function(c,g){var h,i,j,k,l=g.item[0],m=a.utils.domData.get(l,d);if(m){h=a.utils.domData.get(l,f),i=a.utils.domData.get(l.parentNode,e),j=a.utils.arrayIndexOf(g.item.parent().children(),l);if(p.beforeMove||p.afterMove)k={item:m,sourceParent:h,sourceParentNode:l.parentNode,sourceIndex:h.indexOf(m),targetParent:i,targetIndex:j,cancelDrop:!1};if(p.beforeMove){p.beforeMove.call(this,k,c,g);if(k.cancelDrop){b(k.sourceParent===k.targetParent?this:g.sender).sortable("cancel");return}}j>=0&&(h.remove(m),i.splice(j,0,m)),a.utils.domData.set(l,d,null),g.item.remove(),p.afterMove&&p.afterMove.call(this,k,c,g)}r&&r.apply(this,arguments)},connectWith:p.connectClass?"."+p.connectClass:!1})),p.isEnabled!==c&&a.computed({read:function(){m.sortable(a.utils.unwrapObservable(p.isEnabled)?"enable":"disable")},disposeWhenNodeIsRemoved:g})},0),a.utils.domNodeDisposal.addDisposeCallback(g,function(){m.sortable("destroy")}),{controlsDescendantBindings:!0}},update:function(b,c,d,f,g){var i=h(c);a.utils.domData.set(b,e,i.foreach),a.bindingHandlers.template.update(b,function(){return i},d,f,g)},connectClass:"ko_container",allowDrop:!0,afterMove:null,beforeMove:null,options:{}}})(ko,jQuery)